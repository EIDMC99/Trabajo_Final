import re
import csv
from datetime import datetime, timedelta
from google.colab import files

# Estructuras de datos
usuarios = {}
vehiculos = {}
registros_parqueo = []
administradores = {"Gomito58": "SOLO_PES", "ElJefazo": "ContraseÃ±a Innombrable", "ramiro": "orimar", "Hadaro": "Hanro1303", "DarsyD": "2505dars"}
nombre_archivo = {}

ESPACIOS_TOTALES = 64

# Validaciones
def validar_nombre(nombre):
    if not nombre.strip():
      return False, "El nombre no puede estar vacÃ­o ğŸ˜ "

    partes = nombre.strip().split()
    if len(partes) > 2:
        return False, "El nombre no puede tener mÃ¡s de dos palabras âœŒï¸"
    if any(len(p) < 3 or not p.isalpha() for p in partes):
        return False, "Cada nombre debe tener al menos 3 letras y no puede contener nÃºmeros ğŸ‘"
    return True, ""

def validar_apellido(apellido):
    if not apellido.strip():
      return False, "El apellido no puede estar vacÃ­o ğŸ˜ "

    partes = apellido.strip().split()
    if len(partes) > 2:
        return False, "El apellido no puede tener mÃ¡s de dos palabras âœŒï¸"
    if any(len(p) < 3 or not p.isalpha() for p in partes):
        return False, "Cada apellido debe tener al menos 3 letras y no puede contener nÃºmeros ğŸ‘"
    return True, ""

def validar_documento(doc):
    return doc.isdigit() and 3 <= len(doc) <= 15

def validar_placa(placa):
    return bool(re.fullmatch(r'[A-Z]{3}[0-9]{3}', placa.upper()))

# Registro de usuario
def registrar_usuario():
    nombre = input("Ingrese nombre del usuario â¤ï¸: ").strip()
    valido, msg = validar_nombre(nombre)
    if not valido:
        print("âŒ Error:", msg)
        return

    apellido = input("Ingrese apellido del usuario >â©Š<: ").strip()
    valido, msg = validar_apellido(apellido)
    if not valido:
        print("âŒ Error:", msg)
        return

    documento = input("Ingrese documento (solo nÃºmeros): ").strip()
    if not validar_documento(documento):
        print("âŒ El documento debe tener entre 3 y 15 dÃ­gitos")
        return

    placa = input("Ingrese la placa (formato ABC123): ").strip().upper()
    if not validar_placa(placa):
        print("âŒ Placa invÃ¡lida. Debe tener formato 3 letras (sin Ã±) + 3 nÃºmeros")
        return

    if documento in usuarios:
        print("Este usuario ya estÃ¡ registrado ğŸ‘€")
        return

    usuarios[documento] = {
        "nombre": nombre,
        "apellido": apellido,
        "placa": placa
    }
    print("âœ… Usuario registrado correctamente ğŸ˜Š")

# Ingreso del vehÃ­culo
def ingresar_vehiculo():
    documento = input("Ingrese el documento del usuario â¤ï¸: ").strip()
    if documento not in usuarios:
        print("âŒ Usuario no registrado")
        return

    placa = usuarios[documento]['placa']
    if placa in vehiculos:
        print("âŒ Este vehÃ­culo ya estÃ¡ registrado en el parqueadero")
        return

    disponibles = obtener_espacios_disponibles()
    if not disponibles:
        print("âŒ No hay espacios disponibles")
        return

    print(f"Espacios disponibles ({len(disponibles)}):")
    print(disponibles)

    try:
        espacio = int(input("Seleccione el nÃºmero de espacio a ocupar ğŸ‘‰ğŸ‘ˆ: "))
        if espacio not in disponibles:
          print("Espacio ya ocupado ğŸ¥º")
          return
    except ValueError:
      print("âŒ Entrada no valida")
      return

    hora_ingreso = datetime.now()
    vehiculos[placa] = {
        "documento": documento,
        "hora_ingreso": hora_ingreso,
        "espacio": espacio
    }
    print(f"âœ… VehÃ­culo ingresado con Ã©xito al espacio {espacio} a las {hora_ingreso.strftime('%H:%M:%S')} ğŸ˜Š")

def obtener_espacios_disponibles():
  ocupados = {info['espacio'] for info in vehiculos.values()}
  return [i for i in range(1, ESPACIOS_TOTALES + 1) if i not in ocupados]

# Retiro del vehÃ­culo
def retirar_vehiculo():
    placa = input("Ingrese la placa del vehÃ­culo â¤ï¸: ").strip().upper()
    if placa not in vehiculos:
        print("âŒ VehÃ­culo no encontrado.")
        return

    registro = vehiculos.pop(placa)
    hora_ingreso = registro["hora_ingreso"]
    hora_salida = datetime.now()
    tiempo_total = hora_salida - hora_ingreso

    horas = tiempo_total.seconds // 3600
    minutos = (tiempo_total.seconds % 3600) // 60
    cuartos_hora = minutos // 15

    total = horas * 7000 + cuartos_hora * 1500
    if total < 7000:
        total = 7000

    registros_parqueo.append({
        "placa": placa,
        "documento": registro["documento"],
        "ingreso": hora_ingreso,
        "salida": hora_salida,
        "total": total,
        "duracion": tiempo_total
    })

    print(f"\nğŸ§¾ Recibo de pago")
    print(f"Placa: {placa}")
    print(f"Hora ingreso: {hora_ingreso.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"Hora salida: {hora_salida.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸ’µğŸ’°ğŸ’³ Total a pagar: ${total:,}\n")

# MÃ³dulo administrador
def admin():
    usuario = input("Ingrese usuario de administrador ğŸ˜ğŸ‘ŒğŸ”¥: ")
    contrasena = input("Ingrese contraseÃ±a ğŸ¤«: ")

    if administradores.get(usuario) != contrasena:
        print("âŒ Acceso denegado.")
        return

    while True:
      print("\n ğŸ˜ Guarida Super Secreta de los Admin ğŸ˜‰")
      print("1. Ver reportes ğŸ‘€")
      print("2. Exportar registros a CSV ğŸ“„")
      print("3. Volver al menÃº principal â†©ï¸")
      opcion = input("Seleccione una opciÃ³n ğŸ˜Š: ")

      if opcion == "1":
          mostrar_reportes()
      elif opcion == "2":
          exportar_registros_csv()
      elif opcion == "3":
          break
      else:
          print("âŒ OpciÃ³n invÃ¡lida.")

def mostrar_reportes():
    print("\n REPORTES ADMINISTRATIVOS ğŸ“Š")
    print(f"Total de vehÃ­culos registrados ğŸš—: {len(usuarios)}")
    print(f"Total de vehÃ­culos retirados ğŸ’€: {len(registros_parqueo)}")
    print(f"Total de vehÃ­culos sin retirar ğŸ˜Š: {len(vehiculos)}")
    print(f"ğŸ’¸ğŸ¤‘ğŸ’° Total pagos realizados: ${sum(r['total'] for r in registros_parqueo):,}")

    if registros_parqueo:
        promedio = sum(r['duracion'].total_seconds() for r in registros_parqueo) / len(registros_parqueo)
        promedio_td = timedelta(seconds=promedio)
        print(f"Tiempo promedio de estancia ğŸ•’: {promedio_td}")

        maximo = max(registros_parqueo, key=lambda r: r['duracion'])
        minimo = min(registros_parqueo, key=lambda r: r['duracion'])
        print(f"VehÃ­culo con mayor tiempo ğŸ•’: {maximo['placa']} ({maximo['duracion']})")
        print(f"VehÃ­culo con menor tiempo ğŸ•’: {minimo['placa']} ({minimo['duracion']})")

    print("\nLista de usuarios:")
    for doc, datos in usuarios.items():
        print(f"{datos['nombre']} {datos['apellido']} - Doc: {doc} - Placa: {datos['placa']}")

def exportar_registros_csv(nombre_archivo="registros_parqueadero.csv"):
  if not registros_parqueo:
    print("âŒ No hay registros aÃºn")
    return

  with open(nombre_archivo, mode='w', newline="", encoding="utf-8") as file:
    writer = csv.writer(file, delimiter=';')
    writer.writerow(["Documento", "Placa", "Hora de Ingreso", "Hora de Salida", "Tiempo", "Total pagado"])
    for registro in registros_parqueo:
      writer.writerow([
          registro["documento"],
          registro["placa"],
          registro["ingreso"].strftime("%Y-%m-%d %H:%M:%S"),
          registro["salida"].strftime("%Y-%m-%d %H:%M:%S"),
          str(registro["duracion"]),
          registro["total"]
      ])
  print(f"Datos exportados correctamente a ğŸ“„'{nombre_archivo}'.")
  files.download(nombre_archivo)

# MenÃº principal
def menu_principal():
    while True:
        print("""
        ______
       /|_||_\'.__
      (   _    _ _|
      =`-(_)--(_)-' """)
        print("\n 9ï¸5ï¸âƒ£ Bienvenido al Parquedero PÃ¡rchese ğŸš—ğŸ”¥")
        print("1. Registrar usuario ğŸ™‹â€â™‚ï¸")
        print("2. Ingreso de vehÃ­culo ğŸš˜")
        print("3. Retiro de vehÃ­culo ğŸ¤¬")
        print("4. Administrador ğŸ˜")
        print("5. Salir ğŸ‘‹")
        opcion = input("Seleccione una opciÃ³n, Amor ğŸ˜Š: ")

        if opcion == "1":
            registrar_usuario()
        elif opcion == "2":
            ingresar_vehiculo()
        elif opcion == "3":
            retirar_vehiculo()
        elif opcion == "4":
            admin()
        elif opcion == "5":
            print("ğŸ‘‹ Saliendo del programa...")
            break
        else:
            print("OpciÃ³n invÃ¡lida, tontito, Intenta de nuevo ğŸ˜›")

menu_principal()
